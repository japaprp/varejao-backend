<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Área do cliente do Varejão do Povo para cadastro, login, fidelidade e histórico de pedidos.">
  <meta property="og:title" content="Varejão do Povo">
  <meta property="og:description" content="Hortifruti com qualidade, promoções e suporte rápido.">
  <meta property="og:type" content="website">
  <meta property="og:image" content="imagens/pagina-inicial/fundo-inicial.webp">
  <meta property="og:locale" content="pt_BR">
  <meta name="twitter:card" content="summary_large_image">
  <title>Área do Cliente</title>
  <link rel="stylesheet" href="estilo.css?v=20260227-16">
</head>
<body>
  <header>
    <h1>Área do Cliente</h1>
    <p>Login, cadastro e consulta do programa fidelizado por CPF.</p>
  </header>

  <main>
    <div class="acoes page-links">
      <a href="index.html">Início</a>
    </div>

    <p id="statusMsg" class="status-banner" aria-live="polite"></p>

    <section class="admin-layout cliente-shell">
      <aside class="admin-panel auth-panel">
        <h2>Entrar</h2>
        <p class="panel-subtitle">Acesse sua conta para acompanhar fidelidade e pedidos.</p>
        <label class="field-label" for="loginEmail">E-mail</label>
        <input id="loginEmail" name="cliente_email" class="form-input" placeholder="Digite seu e-mail" autocomplete="username" aria-label="E-mail de login">
        <label class="field-label" for="loginSenha">Senha</label>
        <input id="loginSenha" name="cliente_senha" class="form-input" type="password" placeholder="Digite sua senha" autocomplete="current-password" aria-label="Senha de login">
        <div class="acoes">
          <button id="btnLoginCliente" type="button">Entrar</button>
          <button id="btnLogoutCliente" type="button" class="is-hidden">Sair da conta</button>
        </div>
        <div id="profilePhotoArea" class="profile-photo-box is-hidden">
          <img id="profilePhotoPreview" class="profile-photo-preview" alt="Foto de perfil">
          <div class="acoes mt-10">
            <button id="btnSelecionarFoto" type="button" class="btn-outline">Alterar foto</button>
            <button id="btnRemoverFoto" type="button" class="btn-outline">Remover foto</button>
          </div>
          <input id="inputFotoPerfil" type="file" accept="image/*" class="is-hidden" aria-label="Selecionar foto de perfil">
        </div>
        <div id="socialAuthBox" class="mt-12 google-login-wrap">
          <p>Entrar com rede social</p>
          <div class="social-auth-grid">
            <button id="btnGoogleSocial" type="button" class="social-btn social-btn--google">
              <span class="social-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" width="16" height="16" focusable="false" aria-hidden="true">
                  <path fill="#EA4335" d="M12 10.2v3.9h5.5c-.2 1.3-1.5 3.9-5.5 3.9-3.3 0-6-2.7-6-6s2.7-6 6-6c1.9 0 3.2.8 4 1.6l2.7-2.6C17.1 3.4 14.8 2.5 12 2.5 6.8 2.5 2.5 6.8 2.5 12s4.3 9.5 9.5 9.5c5.5 0 9.1-3.8 9.1-9.2 0-.6-.1-1.1-.2-1.6H12z"/>
                </svg>
              </span>
              <span>Google</span>
            </button>
            <button id="btnFacebookSocial" type="button" class="social-btn social-btn--facebook">
              <span class="social-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" width="16" height="16" focusable="false" aria-hidden="true">
                  <path fill="currentColor" d="M13.3 22v-8h2.7l.4-3.1h-3.1V9c0-.9.2-1.6 1.5-1.6h1.7V4.6c-.3 0-1.3-.1-2.5-.1-2.4 0-4.1 1.5-4.1 4.3v2.4H7v3.1h2.9v8h3.4z"/>
                </svg>
              </span>
              <span>Facebook</span>
            </button>
          </div>
          <small id="googleLoginHint" class="status-banner status-muted">Google: carregando configuração...</small>
          <small id="facebookLoginHint" class="status-banner status-muted">Facebook: carregando configuração...</small>
        </div>
        <small id="socialAuthUnavailable" class="status-banner status-muted is-hidden">Login social indisponível neste ambiente.</small>
        <div class="cadastro-shortcut mt-16">
          <p>Não tem conta?</p>
          <button id="btnMostrarCadastro" type="button" class="btn-outline">Cadastrar</button>
        </div>
      </aside>

      <section id="fidelidadeArea" class="admin-table-wrap is-hidden">
        <h2>Programa Fidelizado</h2>
        <p>Consulte seu progresso e cupons ganhos.</p>
        <div class="acoes">
          <input id="cpfConsulta" placeholder="Digite seu CPF" aria-label="CPF para consulta de fidelidade">
          <button id="btnConsultarFidelidade" type="button">Consultar</button>
        </div>
        <div id="fidelidadeResultado" class="info-card mt-12">
          <p class="status-muted">Digite um CPF para visualizar progresso e cupons.</p>
        </div>
      </section>
    </section>

    <section id="historicoArea" class="admin-layout mt-16 is-hidden">
      <section class="admin-table-wrap">
        <h2>Histórico de Compras</h2>
        <p>Visualize seus pedidos usando o CPF.</p>
        <div class="acoes">
          <input id="cpfHistorico" placeholder="CPF para histórico" aria-label="CPF para histórico de compras">
          <button id="btnCarregarHistorico" type="button">Carregar histórico</button>
        </div>
        <table class="admin-table mt-12">
          <thead>
            <tr><th>Data</th><th>Itens</th><th>Frete</th><th>Total</th><th>Status</th></tr>
          </thead>
          <tbody id="historicoBody">
            <tr><td colspan="5" class="status-muted">Informe um CPF para carregar o histórico.</td></tr>
          </tbody>
        </table>
      </section>
    </section>
  </main>

  <script src="app-core.js?v=20260227-1"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
    const API = AppCore.resolveApiBase();
    let googleReady = false;
    let facebookReady = false;
    let facebookAppId = '';

    function showStatus(msg, type = 'status-info') {
      const el = document.getElementById('statusMsg');
      el.textContent = msg;
      el.className = `status-banner ${type}`;
    }
    function esc(v) {
      return String(v ?? '').replace(/[&<>"']/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
    }

    function money(v) { return Number(v).toFixed(2).replace('.', ','); }

    function onlyDigits(v) {
      return String(v || '').replace(/\D/g, '');
    }

    function formatCpf(v) {
      const d = onlyDigits(v).slice(0, 11);
      return d
        .replace(/^(\d{3})(\d)/, '$1.$2')
        .replace(/^(\d{3})\.(\d{3})(\d)/, '$1.$2.$3')
        .replace(/\.(\d{3})(\d)/, '.$1-$2');
    }

    async function loginCliente() {
      const email = document.getElementById('loginEmail').value.trim();
      const senha = document.getElementById('loginSenha').value;

      const res = await fetch(`${API}/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, senha })
      });
      const body = await res.json().catch(() => ({}));

      if (!res.ok) {
        showStatus(body.erro || 'Falha no login.', 'status-error');
        return;
      }

      localStorage.setItem('cliente_token', body.token);
      localStorage.setItem('cliente_dados', JSON.stringify(body.usuario));
      if (String(body.usuario?.role || '').toLowerCase() === 'admin') {
        localStorage.setItem('admin_token', body.token);
        showStatus('Acesso administrativo detectado. Redirecionando...', 'status-success');
        setTimeout(() => {
          window.location.href = `admin.html?api=${encodeURIComponent(API)}`;
        }, 500);
        return;
      }
      showStatus(`Bem-vindo, ${body.usuario.nome}!`, 'status-success');
      renderClienteSession();
    }

    async function loginComGoogle(idToken) {
      const res = await fetch(`${API}/auth/google`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ idToken })
      });
      const body = await res.json().catch(() => ({}));
      if (!res.ok) {
        showStatus(body.erro || 'Falha no login com Google.', 'status-error');
        return;
      }
      localStorage.setItem('cliente_token', body.token);
      localStorage.setItem('cliente_dados', JSON.stringify(body.usuario));
      showStatus(`Bem-vindo, ${body.usuario.nome}!`, 'status-success');
      renderClienteSession();
    }

    async function loginComFacebook(accessToken) {
      const res = await fetch(`${API}/auth/facebook`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ accessToken })
      });
      const body = await res.json().catch(() => ({}));
      if (!res.ok) {
        showStatus(body.erro || 'Falha no login com Facebook.', 'status-error');
        return;
      }
      localStorage.setItem('cliente_token', body.token);
      localStorage.setItem('cliente_dados', JSON.stringify(body.usuario));
      showStatus(`Bem-vindo, ${body.usuario.nome}!`, 'status-success');
      renderClienteSession();
    }

    async function initGoogleAuth() {
      const hint = document.getElementById('googleLoginHint');
      try {
        const res = await fetch(`${API}/auth/google/config`);
        const cfg = await res.json().catch(() => ({}));
        if (!res.ok) {
          hint.textContent = 'Google indisponível neste ambiente.';
          hint.className = 'status-banner status-muted';
          document.getElementById('btnGoogleSocial').disabled = true;
          return;
        }
        if (!cfg.enabled || !cfg.clientId) {
          hint.textContent = 'Login Google indisponível neste ambiente.';
          hint.className = 'status-banner status-muted';
          document.getElementById('btnGoogleSocial').disabled = true;
          return;
        }

        let retries = 8;
        while (retries > 0 && (!window.google || !window.google.accounts || !window.google.accounts.id)) {
          await new Promise((resolve) => setTimeout(resolve, 300));
          retries -= 1;
        }
        if (!window.google || !window.google.accounts || !window.google.accounts.id) {
          hint.textContent = 'Google indisponível neste ambiente.';
          hint.className = 'status-banner status-muted';
          document.getElementById('btnGoogleSocial').disabled = true;
          return;
        }

        window.google.accounts.id.initialize({
          client_id: cfg.clientId,
          callback: (response) => {
            if (!response || !response.credential) {
              showStatus('Falha ao receber token do Google.', 'status-error');
              return;
            }
            loginComGoogle(response.credential);
          }
        });
        googleReady = true;
        hint.textContent = 'Google pronto para entrar.';
        hint.className = 'status-banner status-success';
      } catch {
        hint.textContent = 'Google indisponível neste ambiente.';
        hint.className = 'status-banner status-muted';
        document.getElementById('btnGoogleSocial').disabled = true;
      }
    }

    async function initFacebookAuth() {
      const hint = document.getElementById('facebookLoginHint');
      try {
        const res = await fetch(`${API}/auth/facebook/config`);
        const cfg = await res.json().catch(() => ({}));
        if (!res.ok) {
          hint.textContent = 'Facebook indisponível neste ambiente.';
          hint.className = 'status-banner status-muted';
          document.getElementById('btnFacebookSocial').disabled = true;
          return;
        }
        if (!cfg.enabled || !cfg.appId) {
          hint.textContent = 'Login Facebook indisponível neste ambiente.';
          hint.className = 'status-banner status-muted';
          document.getElementById('btnFacebookSocial').disabled = true;
          return;
        }

        facebookAppId = cfg.appId;
        await loadFacebookSdk(facebookAppId);
        facebookReady = true;
        hint.textContent = 'Facebook pronto para entrar.';
        hint.className = 'status-banner status-success';
      } catch {
        hint.textContent = 'Facebook indisponível neste ambiente.';
        hint.className = 'status-banner status-muted';
        document.getElementById('btnFacebookSocial').disabled = true;
      }
    }

    function loadFacebookSdk(appId) {
      return new Promise((resolve, reject) => {
        if (window.FB) {
          window.FB.init({
            appId,
            cookie: true,
            xfbml: false,
            version: 'v19.0'
          });
          resolve();
          return;
        }
        window.fbAsyncInit = function () {
          window.FB.init({
            appId,
            cookie: true,
            xfbml: false,
            version: 'v19.0'
          });
          resolve();
        };

        const scriptId = 'facebook-jssdk';
        if (document.getElementById(scriptId)) return;
        const script = document.createElement('script');
        script.id = scriptId;
        script.async = true;
        script.defer = true;
        script.src = 'https://connect.facebook.net/pt_BR/sdk.js';
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    function triggerGoogleLogin() {
      if (!googleReady || !window.google?.accounts?.id) {
        showStatus('Login Google ainda não está pronto.', 'status-error');
        return;
      }
      window.google.accounts.id.prompt();
    }

    function triggerFacebookLogin() {
      if (!facebookReady || !window.FB) {
        showStatus('Login Facebook ainda não está pronto.', 'status-error');
        return;
      }
      window.FB.login((response) => {
        const token = response?.authResponse?.accessToken;
        if (!token) {
          showStatus('Login Facebook cancelado ou não autorizado.', 'status-error');
          return;
        }
        loginComFacebook(token);
      }, { scope: 'public_profile,email' });
    }

    async function consultarFidelidade() {
      const cpf = document.getElementById('cpfConsulta').value.trim();
      const box = document.getElementById('fidelidadeResultado');
      if (!cpf) {
        showStatus('Informe um CPF para consulta.', 'status-error');
        return;
      }

      const res = await fetch(`${API}/fidelidade/${encodeURIComponent(cpf)}`);
      const body = await res.json().catch(() => ({}));
      if (!res.ok) {
        box.innerHTML = '<p>CPF ainda não encontrado no programa.</p>';
        showStatus(body.erro || 'Não foi possível consultar fidelidade.', 'status-error');
        return;
      }

      box.innerHTML = `
        <h3>${esc(body.nome || 'Cliente')}</h3>
        <p>Total gasto: <strong>R$ ${money(body.totalGasto || 0)}</strong></p>
        <p>Progresso para proxima recompensa: <strong>R$ ${money(body.progressoGasto || 0)}</strong> de R$ 200,00</p>
        <p>Recompensas geradas: <strong>${body.recompensasGeradas || 0}</strong></p>
        <p>Cupons ganhos: <strong>${esc((body.cupons || []).join(', ') || 'Nenhum ainda')}</strong></p>
      `;
      showStatus('Consulta de fidelidade carregada.', 'status-success');
    }

    async function carregarHistorico() {
      const cpf = document.getElementById('cpfHistorico').value.trim();
      const body = document.getElementById('historicoBody');
      body.innerHTML = '';
      if (!cpf) {
        showStatus('Informe um CPF para buscar histórico.', 'status-error');
        return;
      }

      try {
        const res = await fetch(`${API}/pedidos?cpf=${encodeURIComponent(cpf)}`);
        if (!res.ok) throw new Error('Falha ao carregar histórico.');
        const pedidos = await res.json();

        if (!pedidos.length) {
          body.innerHTML = '<tr><td colspan="5">Nenhum pedido encontrado.</td></tr>';
          showStatus('Nenhum pedido encontrado para este CPF.', 'status-info');
          return;
        }

        pedidos.forEach((p) => {
          const dt = new Date(p.createdAt);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${dt.toLocaleDateString('pt-BR')}</td>
            <td>${(p.itens || []).length}</td>
            <td>R$ ${money(p.frete || 0)}</td>
            <td>R$ ${money(p.total || 0)}</td>
            <td>${esc(p.status || 'Finalizado')}</td>
          `;
          body.appendChild(tr);
        });

        showStatus('Histórico carregado com sucesso.', 'status-success');
      } catch (err) {
        showStatus(err.message, 'status-error');
      }
    }

    (function preloadCpf() {
      const raw = localStorage.getItem('cliente_dados');
      if (!raw) return;
      try {
        const u = JSON.parse(raw);
        if (u.cpf) document.getElementById('cpfConsulta').value = u.cpf;
        if (u.cpf) document.getElementById('cpfHistorico').value = u.cpf;
      } catch (_) {}
    })();

    function renderClienteSession() {
      const raw = localStorage.getItem('cliente_dados');
      const token = localStorage.getItem('cliente_token');
      const logoutBtn = document.getElementById('btnLogoutCliente');
      const photoArea = document.getElementById('profilePhotoArea');
      const fidelidadeArea = document.getElementById('fidelidadeArea');
      const historicoArea = document.getElementById('historicoArea');
      const isLogged = Boolean(raw && token);

      if (isLogged) {
        fidelidadeArea.classList.remove('is-hidden');
        historicoArea.classList.remove('is-hidden');
      } else {
        fidelidadeArea.classList.add('is-hidden');
        historicoArea.classList.add('is-hidden');
      }

      if (!raw) {
        logoutBtn.classList.add('is-hidden');
        photoArea.classList.add('is-hidden');
        showStatus('Entre na sua conta para ver fidelidade e histórico de compras.', 'status-info');
        return;
      }
      try {
        const user = JSON.parse(raw);
        if (user?.nome) {
          showStatus(`Sessão ativa: ${user.nome}`, 'status-info');
        }
        logoutBtn.classList.remove('is-hidden');
        photoArea.classList.remove('is-hidden');
        renderProfilePhoto();
      } catch {
        logoutBtn.classList.add('is-hidden');
        photoArea.classList.add('is-hidden');
      }
    }

    function getProfilePhotoKey() {
      const raw = localStorage.getItem('cliente_dados');
      if (!raw) return 'cliente_profile_image';
      try {
        const user = JSON.parse(raw);
        const email = String(user?.email || '').trim().toLowerCase();
        if (!email) return 'cliente_profile_image';
        return `cliente_profile_image_${email}`;
      } catch {
        return 'cliente_profile_image';
      }
    }

    function renderProfilePhoto() {
      const preview = document.getElementById('profilePhotoPreview');
      const key = getProfilePhotoKey();
      const img = localStorage.getItem(key) || '';
      if (!img) {
        preview.removeAttribute('src');
        preview.classList.add('is-hidden');
        return;
      }
      preview.src = img;
      preview.classList.remove('is-hidden');
    }

    function onSelectProfilePhoto() {
      document.getElementById('inputFotoPerfil').click();
    }

    function onProfilePhotoChange(ev) {
      const file = ev.target.files && ev.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const key = getProfilePhotoKey();
        localStorage.setItem(key, String(reader.result || ''));
        renderProfilePhoto();
        showStatus('Foto de perfil atualizada.', 'status-success');
      };
      reader.onerror = () => {
        showStatus('Não foi possível carregar a foto.', 'status-error');
      };
      reader.readAsDataURL(file);
    }

    function removeProfilePhoto() {
      const key = getProfilePhotoKey();
      localStorage.removeItem(key);
      renderProfilePhoto();
      showStatus('Foto de perfil removida.', 'status-info');
    }

    function logoutCliente() {
      localStorage.removeItem('cliente_token');
      localStorage.removeItem('cliente_dados');
      localStorage.removeItem('admin_token');
      document.getElementById('loginSenha').value = '';
      document.getElementById('btnLogoutCliente').classList.add('is-hidden');
      document.getElementById('profilePhotoArea').classList.add('is-hidden');
      document.getElementById('fidelidadeArea').classList.add('is-hidden');
      document.getElementById('historicoArea').classList.add('is-hidden');
      showStatus('Sessão encerrada.', 'status-info');
    }

    function bindCpfMasks() {
      const cpfConsultaEl = document.getElementById('cpfConsulta');
      const cpfHistoricoEl = document.getElementById('cpfHistorico');

      cpfConsultaEl.addEventListener('input', () => { cpfConsultaEl.value = formatCpf(cpfConsultaEl.value); });
      cpfHistoricoEl.addEventListener('input', () => { cpfHistoricoEl.value = formatCpf(cpfHistoricoEl.value); });
    }

    function refreshSocialAuthUi() {
      const box = document.getElementById('socialAuthBox');
      const unavailable = document.getElementById('socialAuthUnavailable');
      const anyReady = googleReady || facebookReady;
      if (anyReady) {
        box.classList.remove('is-hidden');
        unavailable.classList.add('is-hidden');
      } else {
        box.classList.add('is-hidden');
        unavailable.classList.remove('is-hidden');
      }
    }

    function abrirCadastro() {
      window.location.href = `cadastro.html?api=${encodeURIComponent(API)}`;
    }

    document.querySelectorAll('input, select, textarea').forEach((el) => {
      if (el.getAttribute('aria-label')) return;
      const placeholder = el.getAttribute('placeholder');
      const fallback = placeholder || el.id || 'campo';
      el.setAttribute('aria-label', fallback);
    });

    document.getElementById('btnLoginCliente').addEventListener('click', loginCliente);
    document.getElementById('btnLogoutCliente').addEventListener('click', logoutCliente);
    document.getElementById('btnMostrarCadastro').addEventListener('click', abrirCadastro);
    document.getElementById('btnSelecionarFoto').addEventListener('click', onSelectProfilePhoto);
    document.getElementById('btnRemoverFoto').addEventListener('click', removeProfilePhoto);
    document.getElementById('inputFotoPerfil').addEventListener('change', onProfilePhotoChange);
    document.getElementById('btnGoogleSocial').addEventListener('click', triggerGoogleLogin);
    document.getElementById('btnFacebookSocial').addEventListener('click', triggerFacebookLogin);
    document.getElementById('btnConsultarFidelidade').addEventListener('click', consultarFidelidade);
    document.getElementById('btnCarregarHistorico').addEventListener('click', carregarHistorico);
    document.addEventListener('DOMContentLoaded', () => {
      renderClienteSession();
      bindCpfMasks();
      Promise.allSettled([initGoogleAuth(), initFacebookAuth()]).finally(refreshSocialAuthUi);
    });
  </script>
  <a class="whatsapp-float" href="https://wa.me/5516992596614?text=Ol%C3%A1%2C%20preciso%20de%20suporte%20no%20Varej%C3%A3o%20do%20Povo." target="_blank" rel="noopener noreferrer" aria-label="Suporte via WhatsApp">WhatsApp</a>
  <footer class="centralizar">
    <h4>Varejão do Povo</h4>
    <p>Av. Cásper Líbero, 376, Ribeirão Preto - SP</p>
    <p>WhatsApp: (16) 99259-6614 • Seg a Sáb 07:00 às 19:00</p>
    <div class="author-credit">Desenvolvido por <strong>Yago Fellipe Amorim</strong> • Interesse em contratar: <a href="https://wa.me/5516991145034?text=Ol%C3%A1%2C%20Yago%2C%20vi%20seu%20site%20e%20quero%20falar%20sobre%20um%20projeto." target="_blank" rel="noopener noreferrer">falar no WhatsApp</a></div>
    <div class="social-links">
      <a href="https://wa.me/5516992596614?text=Ol%C3%A1%2C%20preciso%20de%20suporte%20no%20Varej%C3%A3o%20do%20Povo." target="_blank" rel="noopener noreferrer">WhatsApp</a>
      <a href="https://www.facebook.com/people/Varejao-do-Povo/100043319426102/" target="_blank" rel="noopener noreferrer">Facebook</a>
      <a href="#" class="is-disabled" aria-disabled="true" tabindex="-1">Instagram (em breve)</a>
    </div>
  </footer></body>
</html>





















